# Supabase Schema for Reversion Ladder

## Overview
PostgreSQL schema for storing chapters, user progress, sketches, and AI-generated content.

---

## Tables

### 1) `chapters`
Stores narrative chapters and metadata.

```sql
CREATE TABLE chapters (
  id TEXT PRIMARY KEY, -- e.g., "ch01_opening"
  title TEXT NOT NULL,
  description TEXT,
  panels JSONB NOT NULL, -- Full panel array from Reverson Ladder.json
  choice_points JSONB NOT NULL, -- Choice metadata array
  status TEXT DEFAULT 'draft', -- 'draft', 'published'
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 2) `user_progress`
Tracks where each user is in the narrative.

```sql
CREATE TABLE user_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL, -- Anonymous or JWT-based
  chapter_id TEXT NOT NULL REFERENCES chapters(id),
  current_panel_index INT DEFAULT 0,
  choices_path JSONB DEFAULT '[]'::jsonb, -- Array of selected choice IDs
  last_updated TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_progress_user_chapter ON user_progress(user_id, chapter_id);
```

### 3) `user_choices`
Records which branch each user selected at each choice point.

```sql
CREATE TABLE user_choices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  chapter_id TEXT NOT NULL REFERENCES chapters(id),
  choice_id TEXT NOT NULL, -- e.g., "ch01_choice_01"
  selected_branch_id TEXT NOT NULL, -- e.g., "ch01_01_honest"
  timestamp TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_user_choices_user_chapter ON user_choices(user_id, chapter_id);
```

### 4) `sketches`
Stores AI-generated sketch metadata and URLs.

```sql
CREATE TABLE sketches (
  id TEXT PRIMARY KEY, -- e.g., "sk_tribunal_void"
  chapter_id TEXT REFERENCES chapters(id),
  trigger_panel INT,
  prompt TEXT NOT NULL,
  style TEXT,
  mood TEXT,
  image_url TEXT, -- URL from Pollinations.ai or saved locally
  status TEXT DEFAULT 'pending', -- 'pending', 'generated', 'failed'
  generated_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_sketches_chapter ON sketches(chapter_id);
```

### 5) `ai_continuations` (Optional)
Stores AI-generated story continuations.

```sql
CREATE TABLE ai_continuations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  choice_id TEXT NOT NULL,
  selected_branch_id TEXT NOT NULL,
  prompt_used TEXT,
  generated_text TEXT,
  approved BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## Seed Data

Run the SQL generated by:
```bash
node scripts/seed-supabase.js
```

Then paste output into **Supabase Dashboard → SQL Editor** and execute.

---

## Supabase Setup Steps

1. **Create a new Supabase project**
   - Go to [supabase.com](https://supabase.com)
   - Click "New Project" → Choose free tier
   - Note your `Project URL` and `Anon Key`

2. **Run SQL migrations**
   - In Supabase dashboard, open "SQL Editor"
   - Paste the CREATE TABLE statements above
   - Execute

3. **Get credentials**
   - Project Settings → API
   - Copy **Project URL** and **Anon Key**
   - Add to backend `.env`:
     ```
     SUPABASE_URL=https://xxxxx.supabase.co
     SUPABASE_KEY=eyJhbGc...
     ```

4. **Seed Chapter 1**
   - Run: `node scripts/seed-supabase.js`
   - Paste SQL into Supabase SQL Editor
   - Execute

---

## Free Tier Limits
- **Storage:** 500 MB
- **Database:** PostgreSQL with ~500 MB storage
- **Realtime:** Optional (not needed for MVP)
- **Auth:** Free (optional)

**Note:** For MVP with Chapter 1, you'll use <1 MB.
